<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thumbnail Downloader</title>
    <link rel="icon" href="./favicon.svg" type="image/svg+xml" />
    <style>
      :root {
        color-scheme: light;
        font-family: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
      }

      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 56px 20px 96px;
      }

      .card {
        background: #ffffff;
        border-radius: 8px;
        padding: 24px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: grid;
        gap: 0;
        transition: transform 0.35s ease, box-shadow 0.35s ease;
      }

      .card.is-animating {
        transform: scale(1.02);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.14);
      }

      .row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 12px;
      }

      input {
        padding: 16px;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-size: 16px;
        outline: none;
        background: #ffffff;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      }

      input:focus {
        border-color: #4285f4;
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
      }

      input.input-error {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
      }

      button {
        padding: 16px;
        border-radius: 4px;
        border: none;
        background: #dc3545;
        color: #ffffff;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease, opacity 0.2s ease;
      }

      button:hover {
        background: #c82333;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        font-size: 15px;
        color: #333;
        white-space: pre-wrap;
      }

      @media (max-width: 640px) {
        .container {
          padding: 40px 16px 72px;
        }

        .card {
          padding: 24px;
          border-radius: 8px;
        }

        .row {
          grid-template-columns: 1fr;
        }

        button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <section class="card" aria-label="Загрузка обложки">
        <div class="row">
          <input
            id="url-input"
            name="url"
            type="url"
            placeholder="https://youtu.be/dQw4w9WgXcQ"
            autocomplete="off"
            inputmode="url"
            aria-label="Ссылка на YouTube видео"
          />
          <button id="download-btn" type="button">Скачать</button>
        </div>
        <div id="status" class="status" role="status" aria-live="polite"></div>
      </section>
    </main>

    <script>
      const VIDEO_ID_REGEX = /^[a-zA-Z0-9_-]{11}$/;

      async function downloadAsFile(url, filename) {
        const response = await fetch(url, { mode: "cors" });
        if (!response.ok) {
          throw new Error(`Fetch failed: ${response.status}`);
        }

        const blob = await response.blob();
        const objectUrl = URL.createObjectURL(blob);
        const link = document.createElement("a");

        link.href = objectUrl;
        link.download = filename;
        link.target = "_self";
        document.body.appendChild(link);
        link.click();
        link.remove();

        URL.revokeObjectURL(objectUrl);
      }

      function extractVideoId(raw) {
        const value = String(raw ?? "").trim();
        if (!value) {
          return null;
        }

        if (VIDEO_ID_REGEX.test(value)) {
          return value;
        }

        let parsed;
        try {
          parsed = new URL(value);
        } catch {
          return null;
        }

        if (parsed.hostname.includes("youtu.be")) {
          const [id] = parsed.pathname.split("/").filter(Boolean);
          return id && VIDEO_ID_REGEX.test(id) ? id : null;
        }

        const videoParam = parsed.searchParams.get("v");
        if (videoParam && VIDEO_ID_REGEX.test(videoParam)) {
          return videoParam;
        }

        const parts = parsed.pathname.split("/").filter(Boolean);
        const shortsIndex = parts.indexOf("shorts");
        if (shortsIndex !== -1) {
          const candidate = parts[shortsIndex + 1];
          if (candidate && VIDEO_ID_REGEX.test(candidate)) {
            return candidate;
          }
        }

        const embedIndex = parts.indexOf("embed");
        if (embedIndex !== -1) {
          const candidate = parts[embedIndex + 1];
          if (candidate && VIDEO_ID_REGEX.test(candidate)) {
            return candidate;
          }
        }

        return null;
      }

      function makeCandidates(id) {
        return [
          { name: "maxres", url: `https://img.youtube.com/vi/${id}/maxresdefault.jpg` },
          { name: "sd", url: `https://img.youtube.com/vi/${id}/sddefault.jpg` },
          { name: "hq", url: `https://img.youtube.com/vi/${id}/hqdefault.jpg` },
          { name: "mq", url: `https://img.youtube.com/vi/${id}/mqdefault.jpg` },
          { name: "default", url: `https://img.youtube.com/vi/${id}/default.jpg` },
        ];
      }

      async function loadImageInfo(url) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => {
            resolve({ width: img.naturalWidth, height: img.naturalHeight });
          };
          img.onerror = () => reject(new Error("Image load failed"));
          const cacheBust = url.includes("?") ? "&" : "?";
          img.src = `${url}${cacheBust}cacheBust=${Date.now()}`;
        });
      }

      async function pickBestThumbnail(id) {
        const variants = makeCandidates(id);

        for (const variant of variants) {
          try {
            const { width } = await loadImageInfo(variant.url);
            if (width >= 640) {
              return variant;
            }
            if (variant.name !== "maxres") {
              return variant;
            }
          } catch {
            // try next
          }
        }

        return null;
      }

      const urlInput = document.querySelector("#url-input");
      const downloadButton = document.querySelector("#download-btn");
      const statusEl = document.querySelector("#status");
      const cardEl = document.querySelector(".card");

      if (!urlInput || !downloadButton || !statusEl || !cardEl) {
        throw new Error("Required DOM elements not found");
      }

      function setStatus(message) {
        statusEl.textContent = message;
      }

      function setInputError(hasError) {
        urlInput.classList.toggle("input-error", hasError);
        urlInput.setAttribute("aria-invalid", hasError ? "true" : "false");
      }

      function setLoading(isLoading) {
        downloadButton.disabled = isLoading;
        downloadButton.textContent = isLoading ? "Скачиваю…" : "Скачать";
      }

      async function handleDownload() {
        setStatus("");
        setInputError(false);
        cardEl.classList.add("is-animating");
        window.setTimeout(() => {
          cardEl.classList.remove("is-animating");
        }, 420);

        const videoId = extractVideoId(urlInput.value);
        if (!videoId) {
          setInputError(true);
          return;
        }

        setLoading(true);

        try {
          const best = await pickBestThumbnail(videoId);
          if (!best) {
            setStatus("Не нашёл обложку для этого видео.");
            return;
          }

          const filename = `youtube-${videoId}-${best.name}.jpg`;

          try {
            await downloadAsFile(best.url, filename);
            setStatus("");
          } catch {
            setStatus(
              `Не удалось скачать автоматически. Откройте ссылку вручную: ${best.url}`,
            );
          }
        } finally {
          setLoading(false);
        }
      }

      downloadButton.addEventListener("click", handleDownload);
      urlInput.addEventListener("input", () => {
        setInputError(false);
      });
      urlInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          handleDownload();
        }
      });
    </script>
  </body>
</html>
